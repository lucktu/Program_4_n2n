name: manual-scan-all-to-build

on:
  workflow_dispatch:
    inputs:
      build-releases-version:
        description: "Build all releases versions? v2s|v2|v1"
        required: true
        type: boolean
      force_push:
        description: "force push to registry"
        required: true
        type: boolean

jobs:
  scan-all:
    runs-on: ubuntu-latest
    env:
      APP_NAME: n2n_lucktu
      DOCKER_CONTEXT_PATH: .
    permissions:
      contents: read
      packages: write
    outputs:
      version_b_s_rcs: ${{ steps.build_version.outputs.version_b_s_rcs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Check build_version
        id: build_version
        run: |
          PROJECT_ROOT_DIR=$(pwd)
          echo "scan-all - PROJECT_ROOT_DIR: ${PROJECT_ROOT_DIR}"
          cd ./scripts
          chmod +x *.sh
          . init_logger.sh
          . init_path.sh
          . scan_all_save.sh
          LOG_INFO 'scan_all_save Successful'
          . scan_all_build.sh
          LOG_INFO 'scan_all_build Successful'
          version_b_s_rcs=''
          l_build_version_b_s_rcs=(${build_version_b_s_rcs//,/ })
          for version_b_s_rc in ${l_build_version_b_s_rcs[@]}; do
            LOG_INFO "version_b_s_rc: ${version_b_s_rc}"
            version_b_s_rcs="${version_b_s_rcs}, {\"version_b_s_rc\": \"${version_b_s_rc}\"}"
          done
          version_b_s_rcs="${version_b_s_rcs:1} "
          version_b_s_rcs="{\"include\":[${version_b_s_rcs}]}"
          LOG_INFO  version_b_s_rcs: ${version_b_s_rcs}
          echo "version_b_s_rcs=${version_b_s_rcs}" >> $GITHUB_OUTPUT

  build-all:
    needs: [scan-all]
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJSON(needs.scan-all.outputs.version_b_s_rcs) }}

    uses: ./.github/workflows/docker-publish.yml
    with:
      version_b_s_rc: ${{ matrix.version_b_s_rc }}
      force_push: ${{ inputs.force_push }}
    secrets: inherit
  build-releases-version:
    permissions:
      contents: read
      packages: write
      id-token: write
    if: ${{ inputs.build-releases-version }}
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        version_b_s_rc: [v1, v2, v2s]
    uses: ./.github/workflows/docker-publish.yml
    with:
      version_b_s_rc: ${{ matrix.version_b_s_rc }}
      force_push: ${{ inputs.force_push }}
    secrets: inherit
